<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Dayflow HRMS</title>
    <link rel="stylesheet" href="./css/style.css">
</head>
<body>
    <div class="navbar"></div>

    <div class="container">
        <h1 class="mb-3">Admin Dashboard</h1>
        <p style="color: var(--secondary-color); margin-bottom: 2rem;">Manage your organization</p>

        <!-- Statistics -->
        <div class="card-grid">
            <div class="stat-card">
                <div class="stat-card-icon">üë•</div>
                <div class="stat-card-title">Total Employees</div>
                <div class="stat-card-value" id="totalEmployees">-</div>
            </div>

            <div class="stat-card">
                <div class="stat-card-icon" style="background: var(--success-color);">‚úÖ</div>
                <div class="stat-card-title">Present Today</div>
                <div class="stat-card-value" id="presentToday">-</div>
            </div>

            <div class="stat-card">
                <div class="stat-card-icon" style="background: var(--warning-color);">‚è∞</div>
                <div class="stat-card-title">Pending Leave Requests</div>
                <div class="stat-card-value" id="pendingLeaves">-</div>
            </div>

            <div class="stat-card">
                <div class="stat-card-icon" style="background: var(--danger-color);">üèñÔ∏è</div>
                <div class="stat-card-title">On Leave Today</div>
                <div class="stat-card-value" id="onLeaveToday">-</div>
            </div>
        </div>

        <!-- Pending Leave Approvals -->
        <div class="card" style="margin-top: 3rem;">
            <div class="flex-between mb-3">
                <h2 class="card-header">Pending Leave Approvals</h2>
                <a href="./leave.html" class="btn btn-outline">View All</a>
            </div>
            <div id="pendingLeaveApprovals">
                <div class="spinner"></div>
            </div>
        </div>

        <!-- Recent Employees -->
        <div class="card">
            <div class="flex-between mb-3">
                <h2 class="card-header">Recent Employees</h2>
                <button class="btn btn-primary" onclick="openAddEmployeeModal()">‚ûï Add Employee</button>
            </div>
            <div id="recentEmployees">
                <div class="spinner"></div>
            </div>
        </div>

        <!-- Today's Attendance Summary -->
        <div class="card">
            <div class="flex-between mb-3">
                <h2 class="card-header">Today's Attendance Summary</h2>
                <span id="todayDate"></span>
            </div>
            <div id="todayAttendanceSummary">
                <div class="spinner"></div>
            </div>
        </div>
    </div>

    <!-- Leave Approval Modal -->
    <div id="leaveApprovalModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeLeaveModal()">&times;</span>
            <h2 class="modal-header">Leave Request Details</h2>
            <div id="leaveDetails"></div>
            <div class="form-group">
                <label class="form-label">Admin Comments</label>
                <textarea id="adminComments" class="form-textarea" rows="3"></textarea>
            </div>
            <div class="flex gap-2">
                <button class="btn btn-success btn-full" onclick="approveLeave()">Approve</button>
                <button class="btn btn-danger btn-full" onclick="rejectLeave()">Reject</button>
            </div>
        </div>
    </div>

    <!-- Add Employee Modal -->
    <div id="addEmployeeModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <span class="modal-close" onclick="closeAddEmployeeModal()">&times;</span>
            <h2 class="modal-header">‚ûï Add New Employee</h2>
            <form id="addEmployeeForm">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label" for="newFirstName">First Name *</label>
                        <input type="text" id="newFirstName" class="form-input" placeholder="John" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="newLastName">Last Name *</label>
                        <input type="text" id="newLastName" class="form-input" placeholder="Doe" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="newEmployeeId">Employee ID *</label>
                    <input type="text" id="newEmployeeId" class="form-input" placeholder="EMP001" required>
                    <small style="color: var(--secondary-color);">Use uppercase letters and numbers only</small>
                </div>

                <div class="form-group">
                    <label class="form-label" for="newEmail">Email Address *</label>
                    <input type="email" id="newEmail" class="form-input" placeholder="employee@company.com" required>
                </div>

                <div class="form-group">
                    <label class="form-label" for="newPassword">Password *</label>
                    <input type="password" id="newPassword" class="form-input" placeholder="Create password" required>
                    <small style="color: var(--secondary-color);">At least 8 characters with uppercase, lowercase, number & special character</small>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label" for="newDepartment">Department</label>
                        <select id="newDepartment" class="form-select">
                            <option value="IT">IT</option>
                            <option value="HR">HR</option>
                            <option value="Finance">Finance</option>
                            <option value="Marketing">Marketing</option>
                            <option value="Sales">Sales</option>
                            <option value="Operations">Operations</option>
                            <option value="General">General</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="newDesignation">Designation</label>
                        <input type="text" id="newDesignation" class="form-input" placeholder="Software Engineer">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="newRole">Role *</label>
                    <select id="newRole" class="form-select" required>
                        <option value="employee">Employee</option>
                        <option value="hr">HR Officer</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>

                <div class="flex gap-2 mt-3">
                    <button type="submit" class="btn btn-success btn-full">Create Employee</button>
                    <button type="button" class="btn btn-secondary btn-full" onclick="closeAddEmployeeModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script src="./js/app.js"></script>
    <script>
        let selectedLeaveId = null;

        async function loadDashboard() {
            try {
                // Set today's date
                const today = new Date();
                document.getElementById('todayDate').textContent = ui.formatDate(today);

                // Load all data
                loadStatistics();
                loadPendingLeaves();
                loadRecentEmployees();
                loadTodayAttendance();
            } catch (error) {
                console.error('Dashboard load error:', error);
                ui.showError('Failed to load dashboard');
            }
        }

        async function loadStatistics() {
            try {
                // Load total employees
                const employeesResp = await api.get('/employees');
                if (employeesResp.success) {
                    document.getElementById('totalEmployees').textContent = employeesResp.data.length;
                }

                // Load pending leaves
                const leavesResp = await api.get('/leave?status=pending');
                if (leavesResp.success) {
                    document.getElementById('pendingLeaves').textContent = leavesResp.data.length;
                }

                // Load today's attendance
                const today = new Date().toISOString().split('T')[0];
                const attendanceResp = await api.get(`/attendance?startDate=${today}&endDate=${today}`);
                if (attendanceResp.success) {
                    const presentCount = attendanceResp.data.filter(a => a.status === 'present' || a.status === 'half_day').length;
                    const leaveCount = attendanceResp.data.filter(a => a.status === 'leave').length;
                    
                    document.getElementById('presentToday').textContent = presentCount;
                    document.getElementById('onLeaveToday').textContent = leaveCount;
                }
            } catch (error) {
                console.error('Load statistics error:', error);
            }
        }

        async function loadPendingLeaves() {
            try {
                const response = await api.get('/leave?status=pending');
                const container = document.getElementById('pendingLeaveApprovals');

                if (response.success && response.data.length > 0) {
                    const pending = response.data.slice(0, 5);
                    container.innerHTML = `
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Employee</th>
                                        <th>Type</th>
                                        <th>Start Date</th>
                                        <th>End Date</th>
                                        <th>Days</th>
                                        <th>Reason</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${pending.map(leave => `
                                        <tr>
                                            <td>${leave.first_name} ${leave.last_name}</td>
                                            <td>${leave.leave_type.toUpperCase()}</td>
                                            <td>${ui.formatDate(leave.start_date)}</td>
                                            <td>${ui.formatDate(leave.end_date)}</td>
                                            <td>${leave.total_days}</td>
                                            <td>${leave.reason || '-'}</td>
                                            <td>
                                                <button class="btn btn-primary" onclick="openLeaveModal(${leave.id}, '${leave.first_name} ${leave.last_name}', '${leave.leave_type}', '${leave.start_date}', '${leave.end_date}', ${leave.total_days}, '${leave.reason || ''}')">Review</button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    container.innerHTML = '<p style="color: var(--secondary-color);">No pending leave requests.</p>';
                }
            } catch (error) {
                console.error('Load pending leaves error:', error);
                document.getElementById('pendingLeaveApprovals').innerHTML = '<p class="alert alert-error">Failed to load leave requests</p>';
            }
        }

        async function loadRecentEmployees() {
            try {
                const response = await api.get('/employees');
                const container = document.getElementById('recentEmployees');

                if (response.success && response.data.length > 0) {
                    const recent = response.data.slice(0, 10);
                    container.innerHTML = `
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Employee ID</th>
                                        <th>Name</th>
                                        <th>Department</th>
                                        <th>Designation</th>
                                        <th>Email</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${recent.map(emp => `
                                        <tr style="cursor: pointer;" onclick="window.location.href='./profile.html?id=${emp.id}'">
                                            <td>${emp.employee_id}</td>
                                            <td>${emp.first_name} ${emp.last_name}</td>
                                            <td>${emp.department || '-'}</td>
                                            <td>${emp.designation || '-'}</td>
                                            <td>${emp.email}</td>
                                            <td><span class="badge ${ui.getBadgeClass(emp.employment_status)}">${emp.employment_status.toUpperCase()}</span></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    container.innerHTML = '<p style="color: var(--secondary-color);">No employees found.</p>';
                }
            } catch (error) {
                console.error('Load recent employees error:', error);
                document.getElementById('recentEmployees').innerHTML = '<p class="alert alert-error">Failed to load employees</p>';
            }
        }

        async function loadTodayAttendance() {
            try {
                const today = new Date().toISOString().split('T')[0];
                const response = await api.get(`/attendance?startDate=${today}&endDate=${today}`);
                const container = document.getElementById('todayAttendanceSummary');

                if (response.success && response.data.length > 0) {
                    const statusCounts = {
                        present: 0,
                        absent: 0,
                        half_day: 0,
                        leave: 0
                    };

                    response.data.forEach(att => {
                        statusCounts[att.status] = (statusCounts[att.status] || 0) + 1;
                    });

                    container.innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                            <div style="text-align: center; padding: 1rem; background: #d1fae5; border-radius: 8px;">
                                <div style="font-size: 2rem; font-weight: bold; color: #065f46;">${statusCounts.present}</div>
                                <div style="color: #065f46;">Present</div>
                            </div>
                            <div style="text-align: center; padding: 1rem; background: #fee2e2; border-radius: 8px;">
                                <div style="font-size: 2rem; font-weight: bold; color: #991b1b;">${statusCounts.absent}</div>
                                <div style="color: #991b1b;">Absent</div>
                            </div>
                            <div style="text-align: center; padding: 1rem; background: #fed7aa; border-radius: 8px;">
                                <div style="font-size: 2rem; font-weight: bold; color: #92400e;">${statusCounts.half_day}</div>
                                <div style="color: #92400e;">Half Day</div>
                            </div>
                            <div style="text-align: center; padding: 1rem; background: #dbeafe; border-radius: 8px;">
                                <div style="font-size: 2rem; font-weight: bold; color: #1e40af;">${statusCounts.leave}</div>
                                <div style="color: #1e40af;">On Leave</div>
                            </div>
                        </div>
                    `;
                } else {
                    container.innerHTML = '<p style="color: var(--secondary-color);">No attendance records for today.</p>';
                }
            } catch (error) {
                console.error('Load today attendance error:', error);
                document.getElementById('todayAttendanceSummary').innerHTML = '<p class="alert alert-error">Failed to load attendance</p>';
            }
        }

        function openLeaveModal(id, name, type, startDate, endDate, days, reason) {
            selectedLeaveId = id;
            document.getElementById('leaveDetails').innerHTML = `
                <p><strong>Employee:</strong> ${name}</p>
                <p><strong>Leave Type:</strong> ${type.toUpperCase()}</p>
                <p><strong>Start Date:</strong> ${ui.formatDate(startDate)}</p>
                <p><strong>End Date:</strong> ${ui.formatDate(endDate)}</p>
                <p><strong>Total Days:</strong> ${days}</p>
                <p><strong>Reason:</strong> ${reason || 'Not provided'}</p>
            `;
            document.getElementById('leaveApprovalModal').classList.add('active');
        }

        function closeLeaveModal() {
            document.getElementById('leaveApprovalModal').classList.remove('active');
            selectedLeaveId = null;
            document.getElementById('adminComments').value = '';
        }

        async function approveLeave() {
            if (!selectedLeaveId) return;

            try {
                const comments = document.getElementById('adminComments').value;
                const response = await api.put(`/leave/${selectedLeaveId}`, {
                    status: 'approved',
                    adminComments: comments
                });

                if (response.success) {
                    ui.showSuccess('Leave request approved successfully');
                    closeLeaveModal();
                    loadPendingLeaves();
                    loadStatistics();
                }
            } catch (error) {
                ui.showError(error.message);
            }
        }

        async function rejectLeave() {
            if (!selectedLeaveId) return;

            try {
                const comments = document.getElementById('adminComments').value;
                if (!comments) {
                    ui.showError('Please provide a reason for rejection');
                    return;
                }

                const response = await api.put(`/leave/${selectedLeaveId}`, {
                    status: 'rejected',
                    adminComments: comments
                });

                if (response.success) {
                    ui.showSuccess('Leave request rejected');
                    closeLeaveModal();
                    loadPendingLeaves();
                    loadStatistics();
                }
            } catch (error) {
                ui.showError(error.message);
            }
        }

        // Add Employee Modal Functions
        function openAddEmployeeModal() {
            document.getElementById('addEmployeeModal').classList.add('active');
        }

        function closeAddEmployeeModal() {
            document.getElementById('addEmployeeModal').classList.remove('active');
            document.getElementById('addEmployeeForm').reset();
        }

        // Handle Add Employee Form Submission
        document.addEventListener('DOMContentLoaded', () => {
            loadDashboard();
            
            document.getElementById('addEmployeeForm').addEventListener('submit', async (e) => {
                e.preventDefault();

                const formData = {
                    firstName: document.getElementById('newFirstName').value,
                    lastName: document.getElementById('newLastName').value,
                    employeeId: document.getElementById('newEmployeeId').value,
                    email: document.getElementById('newEmail').value,
                    password: document.getElementById('newPassword').value,
                    department: document.getElementById('newDepartment').value,
                    designation: document.getElementById('newDesignation').value,
                    role: document.getElementById('newRole').value
                };

                // Validate employee ID
                if (!validate.employeeId(formData.employeeId)) {
                    ui.showError('Employee ID must contain only uppercase letters and numbers');
                    return;
                }

                // Validate email
                if (!validate.email(formData.email)) {
                    ui.showError('Please enter a valid email address');
                    return;
                }

                // Validate password
                if (!validate.password(formData.password)) {
                    ui.showError('Password must be at least 8 characters with uppercase, lowercase, number, and special character');
                    return;
                }

                try {
                    const submitBtn = e.target.querySelector('button[type=\"submit\"]');
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Creating...';

                    const response = await api.post('/auth/signup', formData);

                    if (response.success) {
                        ui.showSuccess('Employee created successfully!');
                        closeAddEmployeeModal();
                        loadRecentEmployees();
                        loadStatistics();
                    } else {
                        throw new Error(response.message || 'Failed to create employee');
                    }
                } catch (error) {
                    ui.showError(error.message);
                } finally {
                    const submitBtn = e.target.querySelector('button[type=\"submit\"]');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Create Employee';
                }
            });
        });
    </script>
</body>
</html>
